<!DOCTYPE HTML>
<html>
<head>
<title>Are We Compressed Yet?</title>
<meta http-equiv="X-UA-Compatible" content="IE=Edge">
<script src="jquery-2.1.1.js"></script>
<script src="jquery.flot.js"></script>
<script src="jquery.flot.axislabels.js"></script>
<script src="jquery.flot.navigate.js"></script>
<script src="bootstrap.js"></script>
<script>

function regenerate_graph() {
  var selected_graphs = [];
  var metric_index = parseInt($('#metric').val());
  $('.run').each(function() {
    if ($(this).hasClass('selected')) {
      selected_graphs.push($(this).find('.run_id').html());
    }
  });
  $("#rd_graph").html('');
  var graph_requests = [];
  var outfile = $("#video_name").val();
  bd_rate(selected_graphs,outfile);
  var filter_task = $('#run_filter_task').val();
  var logarithmic = $('#logarithmic').prop('checked');
  for (var i in selected_graphs) {
    graph_requests.push($.get('/runs/'+selected_graphs[i]+'/'+filter_task+'/'+outfile));
  }
  $.when.apply($,graph_requests).done(function() {
    // draw chart
    var curves = [];
    if (selected_graphs.length == 1) {
      var argument_list = [ arguments ];
    } else {
      var argument_list = arguments;
    }
    for (var j in argument_list) {
      var curve = [];
      console.log(argument_list[j]);
      var data = argument_list[j][0];
      var lines = data.split('\n');
      for (var i in lines) {
        var line = lines[i].split(' ');
        var point = [line[2]*8/line[1],line[3+metric_index]];
        curve.push(point);
      }
      var series = {
        data: curve,
        label: selected_graphs[j]
      };
      curves.push(series);
    }
    var options = {
      xaxis: {
        axisLabel: 'Bits per Pixel'
      },
      yaxis: {
        axisLabel: 'Picture quality (dB)'
      },
      legend: {
        show: true,
        position: 'se'
      },
      series: {
        lines: {
          lineWidth: 1
        },
        shadowSize: 0
      },
      zoom: {
        interactive: true
      },
      pan: {
        interactive: true
      }
    };
    if (logarithmic) {
      options.xaxis.transform = function (v) { return Math.log(v); };
      options.xaxis.inverseTransform = function (v) { return Math.exp(v); };
    }
    $.plot('#rd_graph',curves,options);
  });
};
function load_job_queue() {
  $.getJSON('/job_queue.json', function(data) {
    for (var i in data) {
      var job = data[i];
      var job_div = $('<div>');
      job_div.html(job.run_id);
      $('#job_queue').append(job_div);
    }
  });
  $.getJSON('/job', function(data) {
    var job = data;
    console.log(job);
    var job_div = $('#current_job');
    if (job) {
      job_div.html(job.run_id);
    } else {
      job_div.html('No jobs running');
    }
  });
}
function bd_rate(selected_graphs,outfile) {
  var filter_task = $('#run_filter_task').val();
  if (selected_graphs.length < 2) return;
  var req = {};
  req['a'] = selected_graphs[1];
  req['b'] = selected_graphs[0];
  switch( $('#bd_rate_range').val() ) {
    case 'whole':
      req['min_bpp'] = '';
      req['max_bpp'] = '';
      break;
    case 'str':
      req['min_bpp'] = 0.1;
      req['max_bpp'] = 0.12;
      break;
    case 'conf':
      req['min_bpp'] = 0.04;
      req['max_bpp'] = 0.05;
      break;
  }
  req['set'] = filter_task;
  $('#bd_rate_title').html(req['a']+' → '+req['b']);
  req['file'] = outfile;
  $.get('/bd_rate',req,function(data) {
    $('#bd_rate').html(data);
  });
}
  
function baseName(str)
{
   var base = new String(str).substring(str.lastIndexOf('/') + 1); 
    if(base.lastIndexOf(".") != -1)       
        base = base.substring(0, base.lastIndexOf("."));
   return base;
}
function load_sets() {
  var filter_task = $('#run_filter_task').val();
  $.getJSON('/sets.json', function(data) {
    $('#video_name').html('');
    var total_option = $('<option>');
    total_option.html('Total');
    total_option.attr('value','total.out');
    $('#video_name').append(total_option);
    for (var i in data[filter_task]) {
      var file_in_set = baseName(data[filter_task][i]);
      var file_option = $('<option>');
      file_option.html(file_in_set);
      file_option.attr('value',file_in_set+'.y4m-daala.out');
      $('#video_name').append(file_option);
    }
  });
}
function load_runs() {
  var filter_task = $('#run_filter_task').val();
  $.getJSON('/list.json', function(data) {
    data.sort(function(a,b) {
      return new Date(b.date) - new Date(a.date);
    });
    $('#runs').html('');
    for (var i in data) {
      var job = data[i];
      if (job.tasks.indexOf(filter_task) != -1) {
        var run = $('<div>')
        run.attr('class','run');
        run.on('click',function() {
          $(this).toggleClass('selected');
          regenerate_graph();
          return false;
        });
        run.append($('<div class="run_id">').html(job.run_id));
        run.append($('<div class="run_meta">').html(job.info.nick));
        run.append($('<div class="run_meta">').html(job.info.commit));
        run.append($('<div class="run_meta">').html(job.date));
        $('#runs').append(run);
      }
    }
  });
}
function load_aws() {
  $.getJSON('/describeAutoScalingInstances',function(data) {
    var table = $('#machineinfo');
    table.html('');
    data.AutoScalingInstances.forEach(function(instance) {
      var instance_row = $('<tr>');
      var instance_id = $('<td>');
      instance_id.html(instance.InstanceId);
      instance_row.append(instance_id);
      instance_row.append($('<td>').html(instance.HealthStatus));
      instance_row.append($('<td>').html(instance.LifecycleState));
      table.append(instance_row);
    });
  });
  $.getJSON('/describeAutoScalingGroups',function(data) {
    var group = data.AutoScalingGroups[0];
    var desired = group.DesiredCapacity;
    var actual = group.Instances.length;
    if (desired > 0) {
      $('#machine_status_text').html(actual+'/'+desired+' machines have started.');
    } else {
      $('#machine_status_text').html('All machines are currently offline.');
    }
  });
}
function refresh_login_required() {
  if ((document.cookie == 'key=') || (document.cookie == '')) {
    $('.loginrequired').addClass('hidden');
  } else {
    $('.loginrequired').removeClass('hidden');
  }
}
function set_key_cookie() {
  var key = $('#key').val();
  document.cookie = 'key='+key;
  refresh_login_required();
}
function clear_key_cookie() {
  document.cookie = 'key=';
  refresh_login_required();
}
function load_job_log() {
  $.get('job_log',function(data) {
    $('#job_log').html(data);
  });
}
function auto_refresh() {
  load_aws();
  load_job_log();
  window.setTimeout(auto_refresh,5000);
}
$(function() {
  refresh_login_required();
  load_runs();
  var date = new Date();
  $('#run_id').val(date.toISOString().replace(/:/g,'-'));
  load_job_queue();
  load_sets();
  auto_refresh();
});
</script>
<!-- <link rel="stylesheet" type="text/css" href="//icecast.org/assets/css/style.css" media="screen, print"> -->
<link rel="stylesheet" type="text/css" href="xiphbar.css" media="screen, print">
<link type="text/css" rel="stylesheet" href="awcy.css"></link>
<link type="text/css" rel="stylesheet" href="bootstrap.css"></link>
<link rel="shortcut icon" href="favicon.png" />
</head>
<body>
<div id="xiphbar">
      <div>
        <a href="http://www.xiph.org/"><img src="xiph-community.svg" alt="the xiph open source community"></a>
        <ul>
            <li><a href="http://www.xiph.org/">Xiph.org</a></li>
            <li><a href="http://www.opus-codec.org/">Opus</a></li>
            <li><a href="http://xiph.org/flac/">FLAC</a></li>
            <li><a href="http://www.icecast.org/">Icecast</a></li>
            <li><a href="http://www.vorbis.com/">Vorbis</a></li>
            <li><a href="http://www.theora.org/">Theora</a></li>
            <li><a href="http://www.speex.org/">Speex</a></li>
            <li><a href="http://www.xspf.org/">XSPF</a></li>
        </ul>
      </div>
</div>
<header>
<h1>Are We Compressed Yet?</h1>
<ul class="nav nav-tabs" role="tablist">
  <li class="active"><a href="#home" role="tab" data-toggle="tab">Home</a></li>
  <li><a href="#submit" role="tab" data-toggle="tab">Submit</a></li>
</ul>
</header>
<noscript>Sorry, this website currently requires <a href="https://www.destroyallsoftware.com/talks/the-birth-and-death-of-javascript">Javascript</a>.</noscript>

<div class="tab-content">

<article id="home" class="container-fluid tab-pane active">
  <div class="row">
    <div id="runbox" class="col-md-3">
      <h2>Runs</h2>
      Filter by: 
      <select id="run_filter_task" onChange="load_runs();load_sets()">
        <option value="video-1-short">video-1-short</option>
        <option value="video-hd-1">video-hd-1</option>
        <option value="ntt-short-1">ntt-short-1</option>
        <option value="subset1">subset1</option>
        <option value="subset2">subset2</option>
        <option value="subset3">subset3</option>
        <option value="subset4">subset4</option>
      </select>
      <div id="runs">
      </div>
    </div>
    <div id="graphbox" class="col-md-9">
      <h2>Graph</h2>
      <select id="metric" onChange="regenerate_graph()">
        <option value="0">PSNR</option>
        <option value="1">PSNR-HVS</option>
        <option value="2">SSIM</option>
        <option value="3" selected>FASTSSIM</option>
      </select>
      <select id="video_name" onChange="regenerate_graph()" style="width: 300px">
        <option value="total.out">Total</option>
      </select>
      <div class="graph_box">
        <div id="rd_graph">
          ⟵Click runs on the left to select.
        </div>
        <label><input id="logarithmic" type="checkbox" checked onChange="regenerate_graph()"></input>Logarithmic</label>
      </div>
    </div>
  </div>
  <div class="row">
    <div class="controlbox col-md-6">
      <h2>BD rate</h2>
      <select id="bd_rate_range" onChange="regenerate_graph()">
        <option value="whole">Entire curve</option>
        <option value="str">Streaming video (0.1 - 0.12 bpp)</option>
        <option value="conf">Video conferencing (0.04 - 0.05 bpp)</option>
      </select>
      <p id="bd_rate_title"></p>
      <pre id="bd_rate"></pre>
    </div>
    <div class="controlbox col-md-6">
      <h2>Selection</h2>
      <div id="selection_info"></div>
    </div>
  </div>
</article>

<article id="submit" class="container tab-pane">  
  <div class="row controlarea">
    <div class="controlbox col-md-4 loginrequired" >
      <h2>Submit job</h2>
      <form action="submit/job" method="post">
        <div class="form-group">
          <label>Run ID</label>
          <input name="run_id" id="run_id" class="form-control"></input>
        </div>
        <div class="form-group">
          <label>Commit Hash</label>
          <input name="commit" class="form-control"></input>
        </div>
        <div class="form-group">
          <label>Subset</label>
          <select name="task" class="form-control">
            <option value="video-1-short">video-1-short, 7 videos, 1-sec durations, 207 MB</option>
            <option value="video-hd-1">video-hd-1, ? videos, ? durations, ? MB</option>
            <option value="ntt-short-1">ntt-short-1, ? videos, ? durations, ? MB</option>
            <option value="subset1">subset1 - 51 images, 77.5 MB</option>
            <option value="subset2">subset2 - 51 images, 79.6 MB</option>
            <option value="subset3">subset3 - 1000 images, 1.58 GB</option>
            <option value="subset4">subset4 - 1000 images, 1.58 GB</option>
          </select>
        </div>
        <div class="form-group">
          <label>IRC nick</label>
          <input name="nick" value="AWCY" class="form-control"></input>
        </div>
        <div class="form-group">
          <button type="submit" class="btn btn-primary">Start Job</button>
        </div>
        <div class="form-group">
          <label>Codec</label>
          <select name="codec" class="form-control">
            <option value="daala">Daala</option>
            <option value="x264">x264</option>
            <option value="x265">x265</option>
            <option value="x265-rt">x265 realtime</option>
            <option value="vp8">VP8</option>
            <option value="vp9">VP9</option>
          </select>
        </div>
      </form>
    </div>
    <div class="controlbox col-md-8">
      <h2>Current job</h2>
      <div id="current_job">No jobs running</div>
      <form action="submit/kill" method="post" class="loginrequired">
        <button type="submit" class="btn btn-danger">Kill</button>
      </form>
      <form action="submit/restart" method="post" class="loginrequired">
        <button type="submit" class="btn btn-danger">Restart Server</button>
      </form>
      <pre id="job_log"></pre>
    </div>
    <div class="controlbox col-md-4">
      <h2>Job queue</h2>
      <div id="job_queue"></div>
    </div>
    <div class="controlbox col-md-4">
      <h2>Machine info</h2>
      <div id="machine_status_text"></div>
      <table id="machineinfo" class="table">
      </table>
      <form action="submit/setDesiredCapacity" method="post" class="loginrequired">
        <select name="DesiredCapacity">
          <option value="0">0</option>
          <option value="2">2</option>
        </select>
        <input type="submit" value="Request Machines"></input>
      </form>
    </div>
    <div class="controlbox col-md-4">
      <h2>Login</h2>
      <label>Key<input name="key" id="key"></input></label>
      <input type="button" value="Login" onClick="set_key_cookie()"></input>
      <input type="button" value="Logout" onClick="clear_key_cookie()"></input>
    </div>
    </div>
  </div>
</article>

</div>

</body>
</html>
